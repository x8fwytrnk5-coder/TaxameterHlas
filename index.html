<!DOCTYPE html>
<html lang="sk">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>ZiskoMeter</title>

<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css">
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

<style>
body{
  margin:0;
  font-family:system-ui,-apple-system,BlinkMacSystemFont;
  background:linear-gradient(135deg,#1e3c72,#2a5298);
  color:#222;
}
.container{
  max-width:720px;
  margin:20px auto;
  background:#fff;
  padding:20px;
  border-radius:16px;
}
h1{
  text-align:center;
  color:#1e3c72;
}
label{
  font-weight:600;
  margin-top:10px;
  display:block;
}
input{
  width:100%;
  padding:12px;
  margin-top:5px;
  border-radius:10px;
  border:1px solid #ccc;
  font-size:16px;
}
.row{
  display:flex;
  gap:8px;
}
button{
  padding:12px;
  border:none;
  border-radius:10px;
  background:#1e88e5;
  color:#fff;
  font-weight:600;
  font-size:15px;
}
button.secondary{
  background:#555;
}
button.warn{
  background:#c62828;
}
button.good{
  background:#2e7d32;
}
#map{
  height:360px;
  margin-top:15px;
  border-radius:14px;
}
.result{
  margin-top:12px;
  padding:12px;
  border-radius:12px;
  background:#f5f7fa;
  font-size:15px;
}
</style>
</head>

<body>

<div class="container">
<h1>ZiskoMeter</h1>

<label>Poloha vozidla</label>
<input id="carPos" readonly placeholder="Naƒç√≠tavam GPS‚Ä¶">

<label>Miesto n√°stupu</label>
<div class="row">
  <input id="pickup" placeholder="Zadaj alebo diktuj adresu">
  <button onclick="dictate('pickup')">üé§</button>
</div>

<label>Cieƒæ klienta</label>
<div class="row">
  <input id="dropoff" placeholder="Zadaj alebo diktuj adresu">
  <button onclick="dictate('dropoff')">üé§</button>
</div>

<label>Cena z cenn√≠ka (‚Ç¨)</label>
<input id="price" type="number">

<button onclick="calculate()">Vypoƒç√≠ta≈•</button>

<div class="row" style="margin-top:10px;">
  <button class="good" onclick="startRide()">Zaƒça≈• jazdu</button>
  <button class="warn" onclick="endRide()">Ukonƒçi≈• jazdu</button>
  <button class="secondary" onclick="openNav()">Navig√°cia</button>
</div>

<div id="map"></div>
<div id="result" class="result">‚Äî</div>
</div>

<script>
/* ================== MAPA ================== */
let map=L.map('map').setView([48.15,17.11],13);
L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(map);

let carMarker=null;
let pickupMarker=null;
let dropMarker=null;
let carLocation=null;

/* ================== GPS ================== */
navigator.geolocation.getCurrentPosition(async pos=>{
  carLocation={lat:pos.coords.latitude,lon:pos.coords.longitude};
  const addr=await reverse(carLocation.lat,carLocation.lon);
  document.getElementById("carPos").value=addr;
  carMarker=L.marker([carLocation.lat,carLocation.lon]).addTo(map).bindPopup("Vozidlo");
  map.setView([carLocation.lat,carLocation.lon],14);
});

/* ================== GEOK√ìDOVANIE ================== */
async function geocode(q){
  const r=await fetch(`https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(q)}`);
  const d=await r.json();
  if(!d.length) return null;
  return {lat:+d[0].lat,lon:+d[0].lon};
}

async function reverse(lat,lon){
  const r=await fetch(`https://nominatim.openstreetmap.org/reverse?format=json&lat=${lat}&lon=${lon}`);
  const d=await r.json();
  return d.display_name||`${lat},${lon}`;
}

/* ================== V√ùPOƒåET ================== */
async function distance(a,b){
  const r=await fetch(`https://router.project-osrm.org/route/v1/driving/${a.lon},${a.lat};${b.lon},${b.lat}?overview=false`);
  const d=await r.json();
  return d.routes[0].distance/1000;
}

async function calculate(){
  const p=document.getElementById("pickup").value;
  const d=document.getElementById("dropoff").value;
  const price=parseFloat(document.getElementById("price").value);

  if(!p||!d||isNaN(price)){ alert("Vypl≈à v≈°etky √∫daje"); return; }
  if(!carLocation){ alert("GPS nie je dostupn√©"); return; }

  const pick=await geocode(p);
  const drop=await geocode(d);
  if(!pick||!drop){ alert("Adresa nebola n√°jden√°"); return; }

  // üîë ULO≈ΩENIE S√öRADN√çC (kritick√©!)
  pickup.dataset.lat=pick.lat;
  pickup.dataset.lon=pick.lon;
  dropoff.dataset.lat=drop.lat;
  dropoff.dataset.lon=drop.lon;

  if(pickupMarker) map.removeLayer(pickupMarker);
  if(dropMarker) map.removeLayer(dropMarker);

  pickupMarker=L.marker([pick.lat,pick.lon]).addTo(map).bindPopup("N√°stup");
  dropMarker=L.marker([drop.lat,drop.lon]).addTo(map).bindPopup("Cieƒæ");

  const d1=await distance(carLocation,pick);
  const d2=await distance(pick,drop);

  const costs=d1*0.31+d2*0.85;
  const recommended=costs*1.2;
  const diff=price-costs;

  document.getElementById("result").innerHTML=
    `Cena: ${price.toFixed(2)} ‚Ç¨<br>
     N√°klady: ${costs.toFixed(2)} ‚Ç¨<br>
     Doporuƒçen√° cena: ${recommended.toFixed(2)} ‚Ç¨<br>
     V√Ωsledok: <b style="color:${diff>=0?'green':'red'}">${diff.toFixed(2)} ‚Ç¨</b>`;
}

/* ================== NAVIG√ÅCIA ================== */
function openNav(){
  const lat=dropoff.dataset.lat;
  const lon=dropoff.dataset.lon;
  if(!lat||!lon){ alert("Najprv vypoƒç√≠taj trasu"); return; }
  window.open(`https://maps.apple.com/?daddr=${lat},${lon}&dirflg=d`);
}

/* ================== HLAS ================== */
function dictate(id){
  if(!('webkitSpeechRecognition'in window)){
    alert("Hlasov√© zad√°vanie nie je podporovan√©");
    return;
  }
  const r=new webkitSpeechRecognition();
  r.lang='sk-SK';
  r.onresult=e=>{
    document.getElementById(id).value=e.results[0][0].transcript;
  };
  r.start();
}

/* ================== JAZDA ================== */
let watchId=null;
function startRide(){
  if(!carLocation){ alert("GPS nie je dostupn√©"); return; }
  watchId=navigator.geolocation.watchPosition(p=>{
    carLocation={lat:p.coords.latitude,lon:p.coords.longitude};
    if(carMarker) map.removeLayer(carMarker);
    carMarker=L.marker([carLocation.lat,carLocation.lon]).addTo(map);
    map.setView([carLocation.lat,carLocation.lon]);
  },null,{enableHighAccuracy:true});
}
function endRide(){
  if(watchId){ navigator.geolocation.clearWatch(watchId); watchId=null; }
  alert("Jazda ukonƒçen√°");
}
</script>
</body>
</html>
