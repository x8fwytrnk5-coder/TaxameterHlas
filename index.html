<!DOCTYPE html>
<html lang="sk">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>ZiskoMeter</title>
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css">
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<style>
body{font-family:-apple-system,BlinkMacSystemFont,Segoe UI,Roboto,Arial;margin:0;padding:15px;
background: linear-gradient(rgba(255,255,255,0.7), rgba(255,255,255,0.7)),
url('https://cdn.pixabay.com/photo/2018/05/04/15/52/taxi-3376963_1280.jpg') no-repeat center center fixed;
background-size: cover;}
.container{max-width:700px;margin:auto;background:rgba(255,255,255,0.95);padding:20px;border-radius:15px;
box-shadow:0 8px 20px rgba(0,0,0,0.3);}
h1{text-align:center;display:flex;align-items:center;justify-content:center;gap:10px;font-size:36px;font-weight:700;color:#ffcc00;text-shadow:2px 2px 6px rgba(0,0,0,0.5);}
h1 i{font-size:50px;}
label{font-weight:600;margin-top:10px;display:block;}
input,button{width:100%;padding:12px;margin-top:5px;font-size:16px;border-radius:6px;border:1px solid #ccc;}
button{background:#007aff;color:#fff;border:none;cursor:pointer;font-weight:600;transition:0.2s;}
button:hover{background:#005ecb;}
#map{height:300px;margin-top:15px;border-radius:12px;border:1px solid #ccc;}
.result,#stats{margin-top:15px;padding:12px;border-radius:10px;font-size:16px;background:#f9f9f9;box-shadow:0 2px 6px rgba(0,0,0,0.2);}
footer{margin-top:25px;text-align:center;font-size:13px;color:#333;}
#lockScreen{position:fixed;inset:0;background:rgba(0,0,0,0.4);display:flex;align-items:center;justify-content:center;z-index:9999;}
#lockScreen div{background:white;padding:25px;border-radius:12px;max-width:320px;width:100%;box-shadow:0 4px 12px rgba(0,0,0,0.3);}
#pinInput{width:100%;padding:12px;font-size:16px;margin-top:5px;}
#pinMsg{color:red;margin-top:10px;}
.suggestions{position:absolute;top:100%;left:0;right:0;background:white;border:1px solid #ccc;z-index:1000;max-height:150px;overflow-y:auto;}
.suggestions div{padding:6px;cursor:pointer;}
.suggestions div:hover{background:#eee;}
.autocomplete-wrapper{position:relative;}
</style>
</head>
<body>

<div id="lockScreen">
  <div>
    <h3>Zadaj PIN</h3>
    <input type="password" id="pinInput" placeholder="PIN">
    <button onclick="unlockApp()">Odomkn√∫≈•</button>
    <div id="pinMsg"></div>
  </div>
</div>

<div class="container">
<h1><i class="fa-solid fa-taxi"></i> ZiskoMeter</h1>

<label>Poloha vozidla</label>
<input id="carPos" placeholder="Naƒç√≠tava sa GPS‚Ä¶" readonly>

<label>Miesto n√°stupu klienta</label>
<div class="autocomplete-wrapper">
  <input id="pickup" placeholder="Zadaj adresu" autocomplete="off">
  <div id="pickupSuggestions" class="suggestions"></div>
</div>

<label>Cieƒæ klienta</label>
<div class="autocomplete-wrapper">
  <input id="dropoff" placeholder="Zadaj cieƒæ" autocomplete="off">
  <div id="dropoffSuggestions" class="suggestions"></div>
</div>

<label>Cena z cenn√≠ka (‚Ç¨)</label>
<input id="price" type="number" placeholder="Zad√° vodiƒç">

<button onclick="calculate()">Vypoƒç√≠ta≈•</button>
<button onclick="showStats()">≈†tatistika d≈àa</button>
<button id="startRideBtn">üöñ Zaƒça≈• jazdu</button>
<button id="toggleWaitBtn">‚è±Ô∏è Zapn√∫≈• ƒçakanie</button>
<p id="waitTime">ƒåakanie: 0 min</p>

<div id="map"></div>
<div id="result" class="result">V√Ωsledok sa zobraz√≠ tu</div>
<div id="stats"></div>
</div>

<script>
// --- PIN aplik√°cie ---
const APP_PIN = "123"; 
function unlockApp(){
  const pin = document.getElementById("pinInput").value;
  if(pin === APP_PIN){
    document.getElementById("lockScreen").style.display = "none";
  } else {
    document.getElementById("pinMsg").textContent = "Nespr√°vny PIN";
  }
}

// --- GPS a mapa ---
let map = L.map('map').setView([48.1486,17.1077],13);
L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png',{attribution:'¬© OpenStreetMap'}).addTo(map);
let markers=[];
let carLocation=null;

async function reverseGeocode(lat, lon){
  const r = await fetch(`https://nominatim.openstreetmap.org/reverse?format=json&lat=${lat}&lon=${lon}`);
  const d = await r.json();
  return d.display_name||`${lat.toFixed(5)},${lon.toFixed(5)}`;
}

navigator.geolocation.getCurrentPosition(async pos=>{
  const lat=pos.coords.latitude;
  const lon=pos.coords.longitude;
  carLocation={lat,lon};
  const address = await reverseGeocode(lat,lon);
  document.getElementById("carPos").value = address;
  map.setView([lat,lon],14);
  markers.push(L.marker([lat,lon]).addTo(map).bindPopup("Vozidlo"));
});

// --- Autocomplete ---
async function fetchSuggestions(query, loc){
  if(!query || !loc) return [];
  const r=await fetch(`https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(query)}&limit=5&viewbox=${loc.lon-0.05},${loc.lat+0.05},${loc.lon+0.05},${loc.lat-0.05}`);
  const d=await r.json();
  return d.map(item=>({display:item.display_name,lat:+item.lat,lon:+item.lon}));
}
function setupAutocomplete(inputId, suggestionId){
  const input=document.getElementById(inputId);
  const suggestionBox=document.getElementById(suggestionId);
  input.addEventListener("input", async ()=>{
    suggestionBox.innerHTML="";
    if(!carLocation) return;
    const results = await fetchSuggestions(input.value, carLocation);
    results.forEach(r=>{
      const div=document.createElement("div");
      div.textContent=r.display;
      div.addEventListener("click", ()=>{
        input.value=r.display;
        input.dataset.lat=r.lat;
        input.dataset.lon=r.lon;
        suggestionBox.innerHTML="";
      });
      suggestionBox.appendChild(div);
    });
  });
}
setupAutocomplete("pickup","pickupSuggestions");
setupAutocomplete("dropoff","dropoffSuggestions");

// --- Ukladanie j√°zd ---
function saveRide(price, costs, km){
  const rides = JSON.parse(localStorage.getItem("rides")||"[]");
  rides.push({price,costs,km,date:new Date().toISOString()});
  localStorage.setItem("rides",JSON.stringify(rides));
}

// --- V√Ωpoƒçty ---
function getRates(){
  return {toClient:0.31,withClient:0.85,services:0};
}
async function geocode(addr){
  const r=await fetch("https://nominatim.openstreetmap.org/search?format=json&q="+encodeURIComponent(addr));
  const d=await r.json();
  return d.length?{lat:+d[0].lat,lon:+d[0].lon}:null;
}
async function distance(a,b){
  const r=await fetch(`https://router.project-osrm.org/route/v1/driving/${a.lon},${a.lat};${b.lon},${b.lat}?overview=false`);
  const d=await r.json();
  return d.routes[0].distance/1000;
}
async function calculate(){
  const result=document.getElementById("result");
  result.textContent="Poƒç√≠tam‚Ä¶";
  try{
    markers.forEach(m=>map.removeLayer(m));
    markers=[];
    const pickupAddr=document.getElementById("pickup").value;
    const dropAddr=document.getElementById("dropoff").value;
    const price=parseFloat(document.getElementById("price").value);
    if(!pickupAddr||!dropAddr||isNaN(price)){ result.textContent="Vypl≈à √∫daje"; return; }
    if(!carLocation){ result.textContent="GPS nie je dostupn√©"; return; }

    let pick={lat:+document.getElementById("pickup").dataset.lat||0, lon:+document.getElementById("pickup").dataset.lon||0};
    let drop={lat:+document.getElementById("dropoff").dataset.lat||0, lon:+document.getElementById("dropoff").dataset.lon||0};
    if(pick.lat===0||drop.lat===0){
      pick=await geocode(pickupAddr);
      drop=await geocode(dropAddr);
      if(!pick||!drop){ result.textContent="Adresu sa nepodarilo n√°js≈•"; return; }
    }

    markers.push(L.marker([carLocation.lat,carLocation.lon]).addTo(map).bindPopup("Vozidlo"));
    markers.push(L.marker([pick.lat,pick.lon]).addTo(map).bindPopup("N√°stup"));
    markers.push(L.marker([drop.lat,drop.lon]).addTo(map).bindPopup("Cieƒæ"));

    const d1 = await distance(carLocation,pick);
    const d2 = await distance(pick,drop);
    const rates = getRates();
    const costs = d1*rates.toClient + d2*rates.withClient + rates.services;
    const recommendedPrice = costs*1.2;
    const diff = price - costs;

    saveRide(price,costs,d1+d2);

    result.innerHTML=
      `Cena z cenn√≠ka: ${price.toFixed(2)} ‚Ç¨<br>
       Doporuƒçen√° cena: <strong style="color:blue">${recommendedPrice.toFixed(2)} ‚Ç¨</strong><br>
       N√°klady: ${costs.toFixed(2)} ‚Ç¨<br>
       Celkov√© km: ${(d1+d2).toFixed(2)} km<br>
       V√Ωsledok: <strong style="color:${diff>=0?'green':'red'}">${diff>=0?'Zisk':'Strata'} ${Math.abs(diff).toFixed(2)} ‚Ç¨</strong>`;
  }catch(e){ result.textContent="Chyba v√Ωpoƒçtu"; console.error(e);}
}

// --- ≈†tatistika ---
function showStats(){
  const rides = JSON.parse(localStorage.getItem("rides")||"[]");
  if(rides.length===0){ alert("≈Ωiadne jazdy na spracovanie."); return; }

  let totalPrice=0, totalCosts=0, totalKm=0;
  const avgSpeed = 40;
  let totalTime=0;

  rides.forEach(r=>{
    totalPrice += r.price;
    totalCosts += r.costs;
    totalKm += r.km;
    totalTime += r.km/avgSpeed;
  });

  const totalProfit = totalPrice - totalCosts;
  const efficiency = totalPrice ? (totalProfit/totalPrice)*100 : 0;
  const realKmPrice = totalKm ? totalPrice/totalKm : 0;

  document.getElementById("stats").innerHTML=
    `<h3>≈†tatistika j√°zd</h3>
     <p>Poƒçet j√°zd: ${rides.length}</p>
     <p>Celkov√© pr√≠jmy: ${totalPrice.toFixed(2)} ‚Ç¨</p>
     <p>Celkov√© n√°klady: ${totalCosts.toFixed(2)} ‚Ç¨</p>
     <p>Celkov√Ω zisk/strata: <strong style="color:${totalProfit>=0?'green':'red'}">${totalProfit.toFixed(2)} ‚Ç¨</strong></p>
     <p>Celkov√© km: ${totalKm.toFixed(2)} km</p>
     <p>Celkov√Ω ƒças jazdenia: ${totalTime.toFixed(2)} h</p>
     <p>Re√°lna cena 1 km: ${realKmPrice.toFixed(2)} ‚Ç¨/km</p>
     <p>Efektivita: ${efficiency.toFixed(1)}%</p>
     <canvas id="efficiencyChart" width="400" height="200"></canvas>`;

  renderChart(rides);
}

function renderChart(rides){
  const ctx=document.getElementById('efficiencyChart').getContext('2d');
  const labels = rides.map((r,i)=>`Jazda ${i+1}`);
  const data = rides.map(r=>r.price-r.costs);
  new Chart(ctx,{
    type:'bar',
    data:{labels, datasets:[{label:'Zisk/Strata (‚Ç¨)', data, backgroundColor:data.map(v=>v>=0?'green':'red')}]},
    options:{responsive:true, plugins:{legend:{display:false}, title:{display:true,text:'Efektivita jednotliv√Ωch j√°zd'}}, scales:{y:{beginAtZero:true}}}
  });
}

// --- Hlasov√© zadanie adries ---
function setupVoiceInput(inputId, buttonText){
  const input = document.getElementById(inputId);
  const btn = document.createElement("button");
  btn.textContent = buttonText;
  btn.style.marginTop = "5px";
  input.parentNode.insertBefore(btn, input.nextSibling);

  const recognition = new (window.SpeechRecognition || window.webkitSpeechRecognition)();
  recognition.lang = 'sk-SK';
  recognition.interimResults = false;

  btn.addEventListener("click", () => { recognition.start(); });
  recognition.onresult = (event) => {
    const transcript = event.results[0][0].transcript;
    input.value = transcript;
    input.dataset.lat = 0;
    input.dataset.lon = 0;
  };
  recognition.onerror = (event) => { alert("Chyba rozpozn√°vania hlasu: " + event.error); };
}
setupVoiceInput("pickup", "üé§ Nahr√°va≈• n√°stup");
setupVoiceInput("dropoff", "üé§ Nahr√°va≈• cieƒæ");

// --- Funkcia Zaƒça≈• jazdu a ƒçakanie ---
let rideActive=false, waitActive=false, waitMinutes=0, waitInterval, rideWatchId;
document.getElementById("startRideBtn").addEventListener("click",()=>{
  if(!carLocation){ alert("GPS nie je dostupn√©"); return; }
  if(!pickup.value||!dropoff.value){ alert("Zadaj adresu n√°stupu a cieƒæa"); return; }

  rideActive=true;
  alert("Jazda spusten√°. Marker bude sledova≈• tvoju polohu.");

  const dest=encodeURIComponent(dropoff.value);
  window.open(`https://www.google.com/maps/dir/?api=1&destination=${dest}&travelmode=driving`,'_blank');

  rideWatchId=navigator.geolocation.watchPosition(pos=>{
    carLocation={lat:pos.coords.latitude, lon:pos.coords.longitude};
    if(markers.length){ map.removeLayer(markers[0]); markers.shift(); }
    markers.unshift(L.marker([carLocation.lat,carLocation.lon]).addTo(map).bindPopup("Vozidlo"));
    map.setView([carLocation.lat,carLocation.lon]);
  }, err=>{ console.error(err); }, {enableHighAccuracy:true, maximumAge:1000});
});

document.getElementById("toggleWaitBtn").addEventListener("click",()=>{
  if(!rideActive){ alert("Najprv spusti jazdu."); return; }
  waitActive=!waitActive;
  if(waitActive){
    waitInterval=setInterval(()=>{ waitMinutes++; document.getElementById("waitTime").textContent=`ƒåakanie: ${waitMinutes} min`; },60000);
    alert("ƒåakanie zapnut√©");
  } else { clearInterval(waitInterval); alert("ƒåakanie vypnut√©"); }
});
</script>
</body>
</html>
