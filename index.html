<!DOCTYPE html>
<html lang="sk">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>ZiskoMeter</title>

<link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
<link rel="stylesheet" href="https://unpkg.com/leaflet-routing-machine/dist/leaflet-routing-machine.css" />
<style>
body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif; background: linear-gradient(135deg,#0f2027,#203a43,#2c5364); color:#fff; margin:0; padding:20px; }
h1 { text-align:center; margin-bottom:10px; }
.card { background: rgba(255,255,255,0.08); border-radius:14px; padding:15px; margin-bottom:15px; }
label { display:block; margin-top:10px; font-size:14px; }
input { width:100%; padding:10px; border-radius:8px; border:none; margin-top:4px; font-size:16px; }
button { width:32%; padding:12px; margin-top:10px; border-radius:10px; border:none; background:#00c853; color:#000; font-size:16px; font-weight:bold; margin-right:1%; }
button.secondary { background:#ff5252; color:#fff; }
.result { font-size:18px; margin-top:10px; text-align:center; }
.green { color:#00e676; }
.red { color:#ff5252; }
.stat { font-size:14px; margin-top:6px; }
#mapContainer { height:300px; margin-top:15px; border-radius:10px; }
</style>
</head>

<body>

<h1>ZiskoMeter</h1>
<p style="text-align:center;font-size:13px;">Autor myšlienky: Peter Lukáč</p>

<div class="card">
  <label>Poloha vozidla (GPS)</label>
  <input id="carAddress" placeholder="Automaticky alebo ručne">
  <label>Miesto nástupu klienta</label>
  <input id="pickupAddress">
  <label>Cieľ klienta</label>
  <input id="dropoffAddress">
</div>

<div class="card">
  <label>Cena z cenníka (€)</label>
  <input id="listedPrice" type="number" step="0.01">
</div>

<div class="card">
  <button onclick="calculateRide()">Vypočítať</button>
</div>

<div class="card">
  <div class="result" id="costResult"></div>
  <div class="result" id="recommendedResult"></div>
  <div class="result" id="profitResult"></div>
</div>

<div class="card">
  <button onclick="startRide()">Začať jazdu</button>
  <button onclick="clientRoute()">Klient</button>
  <button onclick="startWaiting()">Čakanie</button>
</div>

<div id="mapContainer"></div>

<div class="card">
  <h3>Štatistiky</h3>
  <div class="stat" id="statKm">Km spolu: 0</div>
  <div class="stat" id="statCost">Náklady: 0 €</div>
  <div class="stat" id="statRevenue">Tržby: 0 €</div>
  <div class="stat" id="statProfit">Zisk: 0 €</div>
  <button class="secondary" onclick="resetStats()">Zmazať štatistiky</button>
</div>

<script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
<script src="https://unpkg.com/leaflet-routing-machine/dist/leaflet-routing-machine.min.js"></script>

<script>
// --- SETTINGS ---
let settings = {
  pinApp: "0000",
  pinRates: "123456",
  rateToClient: 0.31,
  rateWithClient: 0.85,
  waitingRate: 8 // €/hod
};

// --- STATISTICS ---
let stats = { km:0, cost:0, revenue:0 };
let waitingTime = 0; // simulácia čakania
let waitingInterval;
let currentRideStarted = false;

// --- MAP ---
let map, carMarker, pickupMarker, dropoffMarker, routeLayer, poiMarkers=[];
document.addEventListener("DOMContentLoaded", function(){
  map = L.map('mapContainer').setView([48.15,17.12], 10);
  L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png',{ attribution: '&copy; OpenStreetMap contributors' }).addTo(map);

  if(navigator.geolocation){
    navigator.geolocation.getCurrentPosition(p=>{
      let lat=p.coords.latitude, lng=p.coords.longitude;
      setCarLocation(lat,lng);
    }, err=>{ console.log("Polohu sa nepodarilo získať"); });
  }

  // POI body
  addPOI(48.1486,17.1077,"Hotel Central");
  addPOI(48.1530,17.1150,"Kaviareň Štart");
});

function setCarLocation(lat,lng){
  if(carMarker) map.removeLayer(carMarker);
  carMarker = L.marker([lat,lng]).addTo(map).bindPopup("Vozidlo");
  map.setView([lat,lng],12);
}
function setPickup(lat,lng){
  if(pickupMarker) map.removeLayer(pickupMarker);
  pickupMarker = L.marker([lat,lng]).addTo(map).bindPopup("Nástup klienta");
}
function setDropoff(lat,lng){
  if(dropoffMarker) map.removeLayer(dropoffMarker);
  dropoffMarker = L.marker([lat,lng]).addTo(map).bindPopup("Cieľ klienta");
}
function showRoute(fromLat,fromLng,toLat,toLng){
  if(routeLayer) map.removeLayer(routeLayer);
  routeLayer = L.Routing.control({
    waypoints:[L.latLng(fromLat,fromLng),L.latLng(toLat,toLng)],
    routeWhileDragging:false, show:false
  }).addTo(map);
}
function addPOI(lat,lng,name){
  let marker=L.marker([lat,lng],{icon:L.icon({iconUrl:'https://cdn-icons-png.flaticon.com/512/252/252025.png',iconSize:[30,30]})}).addTo(map).bindPopup(name);
  poiMarkers.push(marker);
}
function clearPOI(){poiMarkers.forEach(m=>map.removeLayer(m)); poiMarkers=[]);}

// --- ROUTES ---
function startRide(){
  if(!carMarker || !pickupMarker){ alert("Najprv zadaj polohu auta a miesto nástupu klienta"); return; }
  let from=carMarker.getLatLng(), to=pickupMarker.getLatLng();
  showRoute(from.lat,from.lng,to.lat,to.lng);
  currentRideStarted=true;
}
function clientRoute(){
  if(!pickupMarker || !dropoffMarker){ alert("Najprv zadaj miesto nástupu a cieľa klienta"); return; }
  let from=pickupMarker.getLatLng(), to=dropoffMarker.getLatLng();
  showRoute(from.lat,from.lng,to.lat,toLng);
}

// --- WAITING ---
function startWaiting(){
  if(waitingInterval) clearInterval(waitingInterval);
  waitingInterval = setInterval(()=>{ waitingTime+=1; console.log("Čakáme: "+waitingTime+" min"); },60000);
}

// --- CALCULATION ---
function roundTaxi(price){
  let whole=Math.floor(price),decimal=price-whole;
  if(decimal<=0.24) return whole;
  if(decimal<=0.49) return whole+0.5;
  return whole+1;
}
function calculateRide(){
  let listedPrice=parseFloat(document.getElementById("listedPrice").value);
  if(isNaN(listedPrice)) return alert("Zadaj cenu z cenníka");

  if(!pickupMarker || !dropoffMarker) return alert("Zadaj adresy nástupu a cieľa klienta");

  // vzdialenosti simulované, neskôr nahradiť skutočným Routing.distance()
  let kmToClient = routeDistance(carMarker, pickupMarker);
  let kmWithClient = routeDistance(pickupMarker, dropoffMarker);

  let costToClient = kmToClient * settings.rateToClient;
  let costWithClient = kmWithClient * settings.rateWithClient;
  let costWaiting = (waitingTime/60)*settings.waitingRate;

  let rawCost = costToClient + costWithClient + costWaiting;
  let totalCost = roundTaxi(rawCost);
  let recommended = roundTaxi(totalCost*1.2);
  let profit = roundTaxi(listedPrice - totalCost);

  document.getElementById("costResult").innerHTML="Náklady: "+totalCost.toFixed(2)+" €";
  document.getElementById("recommendedResult").innerHTML="Doporučená cena: "+recommended.toFixed(2)+" €";

  let profitEl=document.getElementById("profitResult");
  if(profit>=0){ profitEl.innerHTML="ZISK: +"+profit.toFixed(2)+" €"; profitEl.className="result green"; }
  else { profitEl.innerHTML="STRATA: "+profit.toFixed(2)+" €"; profitEl.className="result red"; }

  stats.km += kmToClient + kmWithClient;
  stats.cost += totalCost;
  stats.revenue += listedPrice;
  updateStats();
}
function routeDistance(startMarker, endMarker){
  if(!startMarker || !endMarker) return 0;
  let latlng1=startMarker.getLatLng(), latlng2=endMarker.getLatLng();
  let R=6371;
  let dLat=(latlng2.lat-latlng1.lat)*Math.PI/180;
  let dLon=(latlng2.lng-latlng1.lng)*Math.PI/180;
  let a=Math.sin(dLat/2)*Math.sin(dLat/2)+Math.cos(latlng1.lat*Math.PI/180)*Math.cos(latlng2.lat*Math.PI/180)*Math.sin(dLon/2)*Math.sin(dLon/2);
  let c=2*Math.atan2(Math.sqrt(a),Math.sqrt(1-a));
  return R*c;
}

// --- STATISTICS ---
function updateStats(){
  document.getElementById("statKm").innerText="Km spolu: "+stats.km.toFixed(1);
  document.getElementById("statCost").innerText="Náklady: "+stats.cost.toFixed(2)+" €";
  document.getElementById("statRevenue").innerText="Tržby: "+stats.revenue.toFixed(2)+" €";
  document.getElementById("statProfit").innerText="Zisk: "+(stats.revenue-stats.cost).toFixed(2)+" €";
}
function resetStats(){
  if(confirm("Naozaj zmazať štatistiky?")){
    stats={km:0,cost:0,revenue:0};
    waitingTime=0;
    updateStats();
  }
}
</script>

</body>
</html>
