<!DOCTYPE html>
<html lang="sk">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<!--
Taxi aplikácia – ZiskoMeter
Autor myšlienky a realizácie: Peter Lukáč
Rok: 2025
-->

<title>ZiskoMeter</title>

<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

<style>
body{
  font-family:-apple-system,BlinkMacSystemFont,Segoe UI,Roboto,Arial;
  margin:0;
  padding:15px;
  background: linear-gradient(135deg, #fff4e6, #ffd700);
}
.container{
  max-width:700px;
  margin:auto;
  background:#fff;
  padding:15px;
  border-radius:10px;
}
h1{
  text-align:center;
  display:flex;
  align-items:center;
  justify-content:center;
  gap:10px;
  font-size:32px;
  font-weight:700;
  color:#333;
  text-shadow:1px 1px 4px rgba(0,0,0,0.3);
}
h1 i{
  color:#FFD700;
  font-size:45px;
  filter: drop-shadow(2px 2px 3px rgba(0,0,0,0.5));
}
label{font-weight:600;margin-top:10px;display:block;}
input,button{
  width:100%;
  padding:10px;
  margin-top:5px;
  font-size:16px;
}
button{
  background:#007aff;
  color:#fff;
  border:none;
  border-radius:6px;
}
#map{
  height:300px;
  margin-top:15px;
  border-radius:8px;
}
.result{
  margin-top:15px;
  padding:12px;
  border-radius:6px;
  font-size:16px;
}
footer{
  margin-top:25px;
  text-align:center;
  font-size:13px;
  color:#666;
}
#lockScreen{
  position:fixed;
  inset:0;
  background:#f4f6f8;
  display:flex;
  align-items:center;
  justify-content:center;
  z-index:9999;
}
#lockScreen div{
  background:white;padding:20px;border-radius:10px;max-width:300px;width:100%;
}
#pinInput{
  width:100%;padding:10px;font-size:16px;margin-top:5px;
}
#pinMsg{
  color:red;margin-top:10px;
}
</style>
</head>

<body>

<!-- PIN zamykanie -->
<div id="lockScreen">
  <div>
    <h3>Zadaj PIN</h3>
    <input type="password" id="pinInput" placeholder="PIN">
    <button onclick="unlock()">Odomknúť</button>
    <div id="pinMsg"></div>
  </div>
</div>

<div class="container">
<h1><i class="fa-solid fa-car-side"></i> ZiskoMeter</h1>

<label>Poloha vozidla</label>
<input id="carPos" placeholder="Načítava sa GPS…" readonly>

<label>Miesto nástupu klienta</label>
<input id="pickup" placeholder="Zadaj adresu">

<label>Cieľ klienta</label>
<input id="dropoff" placeholder="Zadaj adresu">

<label>Cena z cenníka (€)</label>
<input id="price" type="number" placeholder="Zadá vodič">

<button onclick="calculate()">Vypočítať</button>

<div id="map"></div>
<div id="result" class="result">Výsledok sa zobrazí tu</div>

<footer>
© 2025 – Autor: <strong>Peter Lukáč</strong><br>
Použitie len so súhlasom autora
</footer>
</div>

<script src="https://cdnjs.cloudflare.com/ajax/libs/crypto-js/4.1.1/crypto-js.min.js"></script>
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

<script>
/*
Taxi aplikácia – ZiskoMeter
Autor: Peter Lukáč
Rok: 2025
*/

/* SKRYTÉ SADZBY */
const COST_PER_KM = 0.31;
const RIDE_PER_KM = 0.85;

/* MAPA */
let map = L.map('map').setView([48.1486,17.1077],13);
L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png',{
  attribution:'© OpenStreetMap'
}).addTo(map);
let markers=[];

/* PIN ZAMYKANIE */
const PIN_HASH = "202cb962ac59075b964b07152d234b70"; // MD5 z "123"
function unlock(){
  const pin = document.getElementById("pinInput").value;
  if(CryptoJS.MD5(pin).toString()===PIN_HASH){
    localStorage.setItem("authorized","true");
    document.getElementById("lockScreen").style.display="none";
  }else{
    document.getElementById("pinMsg").textContent="Nesprávny PIN";
  }
}
if(localStorage.getItem("authorized")==="true"){
  document.getElementById("lockScreen").style.display="none";
}

/* POLA VOZIDLA */
let carLocation = null;

/* REVERSE GEOCODING */
async function reverseGeocode(lat, lon){
  const r = await fetch(
    `https://nominatim.openstreetmap.org/reverse?format=json&lat=${lat}&lon=${lon}`
  );
  const d = await r.json();
  return d.display_name || `${lat.toFixed(5)}, ${lon.toFixed(5)}`;
}

/* GPS */
navigator.geolocation.getCurrentPosition(async pos=>{
  const lat = pos.coords.latitude;
  const lon = pos.coords.longitude;

  carLocation = { lat, lon };

  const address = await reverseGeocode(lat, lon);
  document.getElementById("carPos").value = address;

  map.setView([lat, lon], 14);
  markers.push(L.marker([lat, lon]).addTo(map).bindPopup("Vozidlo"));
});

/* GEOKÓDOVANIE ADRESY */
async function geocode(addr){
  const r=await fetch("https://nominatim.openstreetmap.org/search?format=json&q="+encodeURIComponent(addr));
  const d=await r.json();
  return d.length?{lat:+d[0].lat,lon:+d[0].lon}:null;
}

/* VZDIALENOSŤ */
async function distance(a,b){
  const r=await fetch(`https://router.project-osrm.org/route/v1/driving/${a.lon},${a.lat};${b.lon},${b.lat}?overview=false`);
  const d=await r.json();
  return d.routes[0].distance/1000;
}

/* VÝPOČET */
async function calculate(){
  const result=document.getElementById("result");
  result.textContent="Počítam…";

  try{
    markers.forEach(m=>map.removeLayer(m));
    markers=[];

    const pickupAddr=document.getElementById("pickup").value;
    const dropAddr=document.getElementById("dropoff").value;
    const price=parseFloat(document.getElementById("price").value);

    if(!pickupAddr||!dropAddr||isNaN(price)){
      result.textContent="Vyplň všetky údaje";
      return;
    }

    if(!carLocation){
      result.textContent="GPS poloha nie je dostupná";
      return;
    }

    const carLoc = carLocation;
    const pick = await geocode(pickupAddr);
    const drop = await geocode(dropAddr);

    if(!pick||!drop){
      result.textContent="Adresu sa nepodarilo nájsť";
      return;
    }

    markers.push(L.marker([carLoc.lat,carLoc.lon]).addTo(map).bindPopup("Vozidlo"));
    markers.push(L.marker([pick.lat,pick.lon]).addTo(map).bindPopup("Nástup"));
    markers.push(L.marker([drop.lat,drop.lon]).addTo(map).bindPopup("Cieľ"));

    const d1 = await distance(carLoc,pick);
    const d2 = await distance(pick,drop);

    const costs = (d1+d2)*COST_PER_KM;
    const ride = d2*RIDE_PER_KM;
    const diff = price-costs;

    result.innerHTML=
      `Cena jazdy: ${price.toFixed(2)} €<br>
       Náklady: ${costs.toFixed(2)} €<br>
       Výsledok: <strong style="color:${diff>=0?'green':'red'}">
       ${diff>=0?'Zisk':'Strata'} ${Math.abs(diff).toFixed(2)} €</strong>`;
  }catch(e){
    result.textContent="Chyba výpočtu";
    console.error(e);
  }
}
</script>
</body>
</html>
