<!DOCTYPE html>
<html lang="sk">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>ZiskoMeter</title>
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css">
<style>
body { margin:0;font-family:'Segoe UI',Roboto,sans-serif;background:linear-gradient(135deg,#0f2027,#203a43,#2c5364);color:#fff; }
header { padding:20px;text-align:center;font-size:26px;font-weight:700;letter-spacing:1px;background:rgba(255,255,255,0.1);backdrop-filter:blur(10px);border-bottom:1px solid rgba(255,255,255,0.2);}
.container { padding:20px; }
input, select { width:100%; padding:14px;margin-bottom:10px;border-radius:12px;border:none;font-size:16px;outline:none;}
input::placeholder{color:rgba(255,255,255,0.7);}
button { padding:14px;font-size:16px;border-radius:12px;border:none;cursor:pointer;font-weight:700;transition:transform 0.1s ease,box-shadow 0.1s ease; }
button:hover { transform:scale(1.05); box-shadow:0px 4px 10px rgba(0,0,0,0.3);}
.btn { background: linear-gradient(90deg,#ffcc00,#ffdd33); color:#000; margin-bottom:10px;}
.btn-row { display:flex; gap:10px; flex-wrap:wrap; margin-bottom:12px;}
.btn-row button { flex:1; }
.box { background:rgba(0,0,0,0.35); padding:16px; border-radius:14px; margin-top:12px; }
.green { color:#4cff4c; font-weight:700;}
.red { color:#ff5c5c; font-weight:700;}
#map { height:300px; margin-top:12px; border-radius:14px; border:2px solid rgba(255,255,255,0.2);}
canvas { background: rgba(255,255,255,0.95); border-radius:12px; margin-top:10px; width:100%; max-height:200px;}
.suggestions { background:white;color:black;border-radius:8px;margin-bottom:8px;max-height:160px;overflow-y:auto;}
.suggestions div { padding:10px;border-bottom:1px solid #ddd; }
.suggestions div:hover { background:#eee; cursor:pointer; }
.modal{display:none;position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,0.7);justify-content:center;align-items:center;}
.modal-content{background:#fff;color:#000;padding:20px;border-radius:10px;width:80%;max-width:300px;text-align:center;}
.modal-content input{width:80%;margin:8px 0;}
</style>
</head>
<body>
<header>ğŸš– ZiskoMeter</header>
<div class="container">

<!-- Poloha vozidla -->
<button class="btn" onclick="getGPS()">ğŸ“ UrÄiÅ¥ polohu vozidla</button>

<!-- Adresy -->
<input id="pickup" placeholder="Miesto nÃ¡stupu klienta" autocomplete="off">
<div id="pickupSug" class="suggestions"></div>

<input id="dropoff" placeholder="CieÄ¾ klienta" autocomplete="off">
<div id="dropoffSug" class="suggestions"></div>

<!-- Cena z cennÃ­ka -->
<input id="priceInput" type="number" placeholder="Cena z cennÃ­ka (â‚¬)">
<button class="btn" onclick="calculate()">ğŸ“ VypoÄÃ­taÅ¥ trasu</button>

<!-- TlaÄidlÃ¡ jazdy -->
<div class="btn-row">
  <button onclick="startRide()">ğŸš— ZaÄaÅ¥ jazdu</button>
  <button onclick="endRide()">ğŸ›‘ UkonÄiÅ¥ jazdu</button>
  <button onclick="navClientRoute()">ğŸ‘¤ Klient</button>
  <button onclick="startWait()">â±ï¸ ZaÄaÅ¥ Äakanie</button>
</div>

<!-- PrÃ­platky -->
<input id="luggage" type="number" placeholder="PoÄet batoÅ¾Ã­n">

<!-- VÃ½sledky -->
<div class="box">
  <div id="results"></div>
</div>

<!-- Å tatistiky -->
<div class="box">
  <button class="btn" onclick="showStats()">ğŸ“Š Å tatistiky dÅˆa</button>
  <button class="btn" onclick="clearStats()">âŒ ZmazaÅ¥ Å¡tatistiku</button>
  <canvas id="chart"></canvas>
</div>

<!-- POI -->
<div class="box">
  <select id="poiType">
    <option value="hotel">ğŸ¨ Ubytovanie</option>
    <option value="restaurant">ğŸ´ ObÄerstvenie</option>
    <option value="fuel">â›½ ÄŒerpacia stanica</option>
  </select>
  <button class="btn" onclick="showPOI()">ğŸ” ZobraziÅ¥ POI na trase</button>
</div>

<!-- Nastavenie sadzieb -->
<div class="box">
  <button class="btn" onclick="showPinModal()">âš™ï¸ Nastavenie sadzieb</button>
</div>

<!-- Mapa -->
<div id="map"></div>

<!-- Modal PIN -->
<div id="pinModal" class="modal">
  <div class="modal-content">
    <p>Zadaj PIN pre Ãºpravu sadzieb</p>
    <input type="password" id="pinInput" placeholder="PIN">
    <button onclick="checkPin()">PotvrdiÅ¥</button>
  </div>
</div>

<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<script>
// --- KonÅ¡tanty a premennÃ© ---
const RATE_TO_CLIENT=0.31; const RATE_WITH_CLIENT=0.85; const RECOMMENDED_MARGIN=0.20; const WAIT_RATE=10;
let APP_PIN="0000"; let SADZBY_PIN="123456";
let map, carMarker, pickupMarker, dropMarker;
let carLat, carLon, pickupLat, pickupLon, dropLat, dropLon;
let distToClient=0, distWithClient=0;
let currentRide=null, waitStart=null, poiMarkers=[];

// --- InicializÃ¡cia mapy ---
map=L.map('map').setView([48.15,17.11],13);
L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(map);

// --- PIN aplikÃ¡cie ---
window.onload = () => {
  const pin = prompt("Zadaj PIN pre vstup do aplikÃ¡cie:");
  if(pin!==APP_PIN){
    alert("NesprÃ¡vny PIN. AplikÃ¡cia sa zatvÃ¡ra.");
    document.body.innerHTML="<h2 style='text-align:center;color:red'>PrÃ­stup zamietnutÃ½</h2>";
  }
}

// --- GPS ---
function getGPS(){
  navigator.geolocation.getCurrentPosition(pos=>{
    carLat=pos.coords.latitude; carLon=pos.coords.longitude;
    if(carMarker) map.removeLayer(carMarker);
    carMarker=L.marker([carLat,carLon]).addTo(map).bindPopup("Vozidlo").openPopup();
    map.setView([carLat,carLon],14);
  },()=>alert("GPS sa nepodarilo naÄÃ­taÅ¥"));
}

// --- NaÅ¡eptÃ¡vanie adries ---
async function suggest(input,box){
  if(input.value.length<3){ box.innerHTML=""; return; }
  let url=`https://nominatim.openstreetmap.org/search?format=json&limit=5&q=${encodeURIComponent(input.value)}`;
  if(carLat) url+=`&lat=${carLat}&lon=${carLon}&bounded=1`;
  const r=await fetch(url); const d=await r.json();
  box.innerHTML="";
  d.forEach(p=>{
    const div=document.createElement("div");
    div.textContent=p.display_name;
    div.onclick=()=>{ input.value=p.display_name; box.innerHTML=""; };
    box.appendChild(div);
  });
}
pickup.oninput=()=>suggest(pickup,pickupSug);
dropoff.oninput=()=>suggest(dropoff,dropoffSug);

// --- GeokÃ³dovanie ---
async function geocode(addr){
  const r=await fetch(`https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(addr)}`);
  const d=await r.json();
  if(!d[0]) throw "Adresa nenÃ¡jdenÃ¡";
  return {lat:+d[0].lat,lon:+d[0].lon};
}

// --- VzdialenosÅ¥ ---
function km(a,b,c,d){
  const R=6371;
  const dLat=(c-a)*Math.PI/180;
  const dLon=(d-b)*Math.PI/180;
  const x=Math.sin(dLat/2)**2+Math.cos(a*Math.PI/180)*Math.cos(c*Math.PI/180)*Math.sin(dLon/2)**2;
  return R*2*Math.atan2(Math.sqrt(x),Math.sqrt(1-x));
}

// --- VÃ½poÄet ---
async function calculate(){
  try{
    if(!carLat) return alert("Najprv urÄ polohu vozidla");
    const p=await geocode(pickup.value); const d=await geocode(dropoff.value);
    pickupLat=p.lat; pickupLon=p.lon; dropLat=d.lat; dropLon=d.lon;
    if(pickupMarker) map.removeLayer(pickupMarker); if(dropMarker) map.removeLayer(dropMarker);
    pickupMarker=L.marker([pickupLat,pickupLon]).addTo(map).bindPopup("NÃ¡stup").openPopup();
    dropMarker=L.marker([dropLat,dropLon]).addTo(map).bindPopup("CieÄ¾").openPopup();
    map.fitBounds([[carLat,carLon],[dropLat,dropLon]]);
    distToClient=km(carLat,carLon,pickupLat,pickupLon)||0;
    distWithClient=km(pickupLat,pickupLon,dropLat,dropLon)||0;
    updateResults();
  }catch(e){ console.error(e); alert("Chyba vÃ½poÄtu. Skontroluj adresy alebo GPS polohu.");}
}

// --- ÄŒakanie ---
function startWait(){ if(waitStart){ alert("ÄŒakanie uÅ¾ beÅ¾Ã­"); return; } waitStart=new Date(); alert("ÄŒakanie spustenÃ©"); }
function calcWaitCost(){ if(!waitStart) return 0; const minutes=(new Date()-waitStart)/60000; waitStart=null; return (minutes/60)*WAIT_RATE; }

// --- AktualizÃ¡cia vÃ½sledkov ---
function updateResults(){
  const price=parseFloat(priceInput.value)||0;
  const luggage=parseInt(document.getElementById("luggage").value)||0;
  const luggageCost=luggage*2;
  const waitCost=calcWaitCost();
  const cost=(distToClient*RATE_TO_CLIENT + distWithClient*RATE_WITH_CLIENT + luggageCost + waitCost)||0;
  const recommended=cost*(1+RECOMMENDED_MARGIN);
  const diff=price-cost;
  results.innerHTML=`
    <p>ğŸš— Km po klienta: ${distToClient.toFixed(2)}</p>
    <p>ğŸ‘¤ Km s klientom: ${distWithClient.toFixed(2)}</p>
    <p>ğŸ’¼ PrÃ­platky: ${luggageCost.toFixed(2)} â‚¬</p>
    <p>â±ï¸ ÄŒakanie: ${waitCost.toFixed(2)} â‚¬</p>
    <p>ğŸ’° NÃ¡klady: ${cost.toFixed(2)} â‚¬</p>
    <p>ğŸ“Š DoporuÄenÃ¡ cena: ${recommended.toFixed(2)} â‚¬</p>
    <p class="${diff>=0?'green':'red'}">${diff>=0?'Zisk':'Strata'}: ${diff.toFixed(2)} â‚¬</p>
  `;
}

// --- Jazdy ---
function startRide(){ if(!carLat||!pickupLat||!dropLat) return alert("ChÃ½ba GPS alebo adresy"); currentRide={startTime:new Date(),kmTo:distToClient,kmWith:distWithClient,cost:distToClient*RATE_TO_CLIENT + distWithClient*RATE_WITH_CLIENT,price:parseFloat(priceInput.value)||0}; alert("Jazda zaÄala"); }
function endRide(){ if(!currentRide) return alert("Jazda nebola zaÄatÃ¡"); currentRide.endTime=new Date(); currentRide.diff=currentRide.price-currentRide.cost; currentRide.duration=((currentRide.endTime-currentRide.startTime)/60000).toFixed(2); let rides=JSON.parse(localStorage.getItem("rides")||"[]"); rides.push(currentRide); localStorage.setItem("rides",JSON.stringify(rides)); currentRide=null; alert("Jazda ukonÄenÃ¡ a uloÅ¾enÃ¡"); }

// --- NavigÃ¡cia ---
function navClientRoute(){ if(!pickupLat||!pickupLon||!dropLat||!dropLon) return alert("Zadaj adresy klienta"); const url=`https://www.google.com/maps/dir/?api=1&origin=${pickupLat},${pickupLon}&destination=${dropLat},${dropLon}&travelmode=driving`; window.open(url,'_blank'); }
function navToPickup(){ if(!carLat||!carLon||!pickupLat||!pickupLon) return alert("GPS alebo adresa chÃ½ba"); const url=`https://www.google.com/maps/dir/?api=1&origin=${carLat},${carLon}&destination=${pickupLat},${pickupLon}&travelmode=driving`; window.open(url,'_blank'); }

// --- POI ---
function showPOI(){ poiMarkers.forEach(m=>map.removeLayer(m)); poiMarkers=[]; const type=document.getElementById("poiType").value; const midLat=(pickupLat+dropLat)/2; const midLon=(pickupLon+dropLon)/2; fetch(`https://nominatim.openstreetmap.org/search?format=json&q=${type}&limit=10&lat=${midLat}&lon=${midLon}`).then(r=>r.json()).then(data=>{ data.forEach(p=>{ const m=L.marker([+p.lat,+p.lon]).addTo(map).bindPopup(p.display_name); poiMarkers.push(m); }); }); }

// --- Å tatistiky ---
let chart=null;
function showStats(){ const rides=JSON.parse(localStorage.getItem("rides")||"[]"); if(rides.length===0) return alert("Å½iadne jazdy zatiaÄ¾"); const labels=rides.map((r,i)=>`Jazda ${i+1}`); const kmData=rides.map(r=>r.kmWith+r.kmTo); const profit=rides.map(r=>r.diff); const ctx=document.getElementById("chart").getContext("2d"); if(chart) chart.destroy(); chart=new Chart(ctx,{type:'bar',data:{labels:labels,datasets:[{label:"Km",data:kmData,backgroundColor:"rgba(75,192,192,0.6)"},{label:"Zisk/Strata â‚¬",data:profit,backgroundColor:"rgba(255,99,132,0.6)"}]},options:{responsive:true,plugins:{legend:{position:"top"}}}}); }
function clearStats(){ if(confirm("Naozaj zmazaÅ¥ vÅ¡etky jazdy?")){ localStorage.removeItem("rides"); if(chart) chart.destroy(); alert("Å tatistika vymazanÃ¡"); }}

// --- PIN modal ---
function showPinModal(){ document.getElementById("pinModal").style.display="flex"; }
function checkPin(){ const val=document.getElementById("pinInput").value; if(val===SADZBY_PIN){ document.getElementById("pinModal").style.display="none"; alert("PIN overenÃ½. Tu by sa zobrazili nastavenia sadzieb (editÃ¡cia koeficientov a prÃ­platkov)"); }else alert("NesprÃ¡vny PIN"); }
window.onclick = e=>{if(e.target.id==="pinModal") e.target.style.display="none";}
</script>
</body>
</html>
