<!DOCTYPE html>
<html lang="sk">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>ZiskoMeter</title>

<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css">

<style>
body{
  margin:0;
  font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,sans-serif;
  background:linear-gradient(135deg,#0f2027,#203a43,#2c5364);
  color:white;
}
header{
  padding:16px;
  text-align:center;
  font-size:22px;
  font-weight:700;
}
.container{padding:15px;}
input{
  width:100%;
  padding:12px;
  margin-bottom:4px;
  border-radius:8px;
  border:none;
  font-size:16px;
}
.suggestions{
  background:white;
  color:black;
  border-radius:8px;
  margin-bottom:8px;
  max-height:160px;
  overflow-y:auto;
}
.suggestions div{
  padding:10px;
  border-bottom:1px solid #ddd;
}
.suggestions div:hover{
  background:#eee;
  cursor:pointer;
}
button{
  padding:14px;
  font-size:16px;
  border-radius:10px;
  border:none;
  cursor:pointer;
}
.btn{
  width:100%;
  background:#ffcc00;
  color:black;
  font-weight:700;
  margin-bottom:8px;
}
.btn-row{display:flex;gap:8px;}
.btn-row button{flex:1;}
#map{
  height:300px;
  margin-top:10px;
  border-radius:10px;
}
.box{
  background:rgba(0,0,0,0.35);
  padding:12px;
  border-radius:10px;
  margin-top:10px;
}
.green{color:#4cff4c;}
.red{color:#ff5c5c;}
</style>
</head>

<body>

<header>ğŸš– ZiskoMeter</header>

<div class="container">

<button class="btn" onclick="getGPS()">ğŸ“ UrÄiÅ¥ polohu vozidla</button>

<input id="pickup" placeholder="Miesto nÃ¡stupu klienta" autocomplete="off">
<div id="pickupSug" class="suggestions"></div>

<input id="dropoff" placeholder="CieÄ¾ klienta" autocomplete="off">
<div id="dropoffSug" class="suggestions"></div>

<button class="btn" onclick="calculate()">ğŸ“ VypoÄÃ­taÅ¥ trasu</button>

<div class="btn-row">
  <button onclick="navToClient()">ğŸš— ZaÄaÅ¥ jazdu</button>
  <button onclick="navClientRoute()">ğŸ‘¤ Klient</button>
</div>

<div class="box">
  <input id="priceInput" type="number" placeholder="Cena z cennÃ­ka (â‚¬)">
  <div id="results"></div>
</div>

<div id="map"></div>

</div>

<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

<script>
/* ==== KONÅ TANTY ==== */
const RATE_TO_CLIENT = 0.31;
const RATE_WITH_CLIENT = 0.85;
const RECOMMENDED_MARGIN = 0.20;

/* ==== PREMENNÃ‰ ==== */
let map, carMarker, pickupMarker, dropMarker;
let carLat, carLon, pickupLat, pickupLon, dropLat, dropLon;
let distToClient=0, distWithClient=0;

/* ==== MAPA ==== */
map=L.map('map').setView([48.15,17.11],13);
L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(map);

/* ==== GPS ==== */
function getGPS(){
  navigator.geolocation.getCurrentPosition(pos=>{
    carLat=pos.coords.latitude;
    carLon=pos.coords.longitude;
    if(carMarker) map.removeLayer(carMarker);
    carMarker=L.marker([carLat,carLon]).addTo(map).bindPopup("Vozidlo").openPopup();
    map.setView([carLat,carLon],14);
  },()=>alert("GPS sa nepodarilo naÄÃ­taÅ¥"));
}

/* ==== AUTOCOMPLETE ==== */
async function suggest(input,box){
  if(input.value.length<3){ box.innerHTML=""; return; }
  let url=`https://nominatim.openstreetmap.org/search?format=json&limit=5&q=${encodeURIComponent(input.value)}`;
  if(carLat){
    url+=`&lat=${carLat}&lon=${carLon}`;
  }
  const r=await fetch(url);
  const d=await r.json();
  box.innerHTML="";
  d.forEach(p=>{
    const div=document.createElement("div");
    div.textContent=p.display_name;
    div.onclick=()=>{
      input.value=p.display_name;
      box.innerHTML="";
    };
    box.appendChild(div);
  });
}

pickup.oninput=()=>suggest(pickup,pickupSug);
dropoff.oninput=()=>suggest(dropoff,dropoffSug);

/* ==== GEOKÃ“D ==== */
async function geocode(addr){
  const r=await fetch(`https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(addr)}`);
  const d=await r.json();
  if(!d[0]) throw "Adresa nenÃ¡jdenÃ¡";
  return {lat:+d[0].lat,lon:+d[0].lon};
}

/* ==== VZDIALENOSÅ¤ ==== */
function km(a,b,c,d){
  const R=6371;
  const dLat=(c-a)*Math.PI/180;
  const dLon=(d-b)*Math.PI/180;
  const x=Math.sin(dLat/2)**2+
    Math.cos(a*Math.PI/180)*Math.cos(c*Math.PI/180)*Math.sin(dLon/2)**2;
  return R*2*Math.atan2(Math.sqrt(x),Math.sqrt(1-x));
}

/* ==== VÃPOÄŒET ==== */
async function calculate(){
  try{
    if(!carLat) return alert("Najprv urÄ polohu vozidla");
    const p=await geocode(pickup.value);
    const d=await geocode(dropoff.value);

    pickupLat=p.lat; pickupLon=p.lon;
    dropLat=d.lat; dropLon=d.lon;

    if(pickupMarker) map.removeLayer(pickupMarker);
    if(dropMarker) map.removeLayer(dropMarker);

    pickupMarker=L.marker([pickupLat,pickupLon]).addTo(map).bindPopup("NÃ¡stup");
    dropMarker=L.marker([dropLat,dropLon]).addTo(map).bindPopup("CieÄ¾");

    map.fitBounds([[carLat,carLon],[dropLat,dropLon]]);

    distToClient=km(carLat,carLon,pickupLat,pickupLon);
    distWithClient=km(pickupLat,pickupLon,dropLat,dropLon);

    updateResults();
  }catch(e){
    alert("Chyba vÃ½poÄtu");
  }
}

/* ==== VÃSLEDKY ==== */
function updateResults(){
  const price=parseFloat(priceInput.value)||0;
  const cost=distToClient*RATE_TO_CLIENT+distWithClient*RATE_WITH_CLIENT;
  const recommended=cost*(1+RECOMMENDED_MARGIN);
  const diff=price-cost;

  results.innerHTML=`
    <p>ğŸš— Km po klienta: ${distToClient.toFixed(2)}</p>
    <p>ğŸ‘¤ Km s klientom: ${distWithClient.toFixed(2)}</p>
    <p>ğŸ’° NÃ¡klady: ${cost.toFixed(2)} â‚¬</p>
    <p>ğŸ“Š DoporuÄenÃ¡ cena: ${recommended.toFixed(2)} â‚¬</p>
    <p class="${diff>=0?'green':'red'}">${diff>=0?'Zisk':'Strata'}: ${diff.toFixed(2)} â‚¬</p>
  `;
}
priceInput.oninput=updateResults;

/* ==== NAVIGÃCIA ==== */
function navToClient(){
  if(!pickupLat) return alert("ChÃ½ba nÃ¡stup");
  window.open(`https://www.google.com/maps/dir/?api=1&destination=${pickupLat},${pickupLon}`);
}
function navClientRoute(){
  if(!pickupLat||!dropLat) return alert("ChÃ½ba trasa");
  window.open(`https://www.google.com/maps/dir/?api=1&origin=${pickupLat},${pickupLon}&destination=${dropLat},${dropLon}`);
}
</script>

</body>
</html>
