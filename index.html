<!DOCTYPE html>
<html lang="sk">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>ZiskoMeter</title>
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css">
<style>
body{margin:0;font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,sans-serif;background:linear-gradient(135deg,#0f2027,#203a43,#2c5364);color:white;}
header{padding:16px;text-align:center;font-size:22px;font-weight:700;}
.container{padding:15px;}
input, select{width:100%;padding:12px;margin-bottom:4px;border-radius:8px;border:none;font-size:16px;}
.suggestions{background:white;color:black;border-radius:8px;margin-bottom:8px;max-height:160px;overflow-y:auto;}
.suggestions div{padding:10px;border-bottom:1px solid #ddd;}
.suggestions div:hover{background:#eee;cursor:pointer;}
button{padding:14px;font-size:16px;border-radius:10px;border:none;cursor:pointer;}
.btn{width:100%;background:#ffcc00;color:black;font-weight:700;margin-bottom:8px;}
.btn-row{display:flex;gap:8px;margin-bottom:8px;}
.btn-row button{flex:1;}
#map{height:300px;margin-top:10px;border-radius:10px;}
.box{background:rgba(0,0,0,0.35);padding:12px;border-radius:10px;margin-top:10px;}
.green{color:#4cff4c;}
.red{color:#ff5c5c;}
canvas{background:white;border-radius:10px;margin-top:10px;width:100%;max-height:200px;}
.modal{display:none;position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,0.7);justify-content:center;align-items:center;}
.modal-content{background:#fff;color:#000;padding:20px;border-radius:10px;width:80%;max-width:300px;text-align:center;}
.modal-content input{width:80%;margin:8px 0;}
</style>
</head>
<body>
<header>ğŸš– ZiskoMeter</header>
<div class="container">

<button class="btn" onclick="getGPS()">ğŸ“ UrÄiÅ¥ polohu vozidla</button>

<input id="pickup" placeholder="Miesto nÃ¡stupu klienta" autocomplete="off">
<div id="pickupSug" class="suggestions"></div>

<input id="dropoff" placeholder="CieÄ¾ klienta" autocomplete="off">
<div id="dropoffSug" class="suggestions"></div>

<input id="priceInput" type="number" placeholder="Cena z cennÃ­ka (â‚¬)">
<button class="btn" onclick="calculate()">ğŸ“ VypoÄÃ­taÅ¥ trasu</button>

<div class="btn-row">
  <button onclick="startRide()">ğŸš— ZaÄaÅ¥ jazdu</button>
  <button onclick="endRide()">ğŸ›‘ UkonÄiÅ¥ jazdu</button>
  <button onclick="navClientRoute()">ğŸ‘¤ Klient</button>
  <button onclick="startWait()">â±ï¸ ZaÄaÅ¥ Äakanie</button>
</div>

<input id="luggage" type="number" placeholder="PoÄet batoÅ¾Ã­n">

<div class="box">
  <div id="results"></div>
</div>

<div class="box">
  <button class="btn" onclick="showStats()">ğŸ“Š Å tatistiky dÅˆa</button>
  <button class="btn" onclick="clearStats()">âŒ ZmazaÅ¥ Å¡tatistiku</button>
  <canvas id="chart"></canvas>
</div>

<div class="box">
  <select id="poiType">
    <option value="hotel">ğŸ¨ Ubytovanie</option>
    <option value="restaurant">ğŸ´ ObÄerstvenie</option>
    <option value="fuel">â›½ ÄŒerpacia stanica</option>
  </select>
  <button class="btn" onclick="showPOI()">ğŸ” ZobraziÅ¥ POI na trase</button>
</div>

<div class="box">
  <button class="btn" onclick="showPinModal()">âš™ï¸ Nastavenie sadzieb</button>
</div>

<div id="map"></div>

<div id="pinModal" class="modal">
  <div class="modal-content">
    <p>Zadaj PIN pre Ãºpravu sadzieb</p>
    <input type="password" id="pinInput" placeholder="PIN">
    <button onclick="checkPin()">PotvrdiÅ¥</button>
  </div>
</div>

<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script>
const RATE_TO_CLIENT=0.31;
const RATE_WITH_CLIENT=0.85;
const RECOMMENDED_MARGIN=0.20;
const WAIT_RATE=10; // â‚¬/hod
let APP_PIN="0000";
let SADZBY_PIN="123456";

let map, carMarker, pickupMarker, dropMarker;
let carLat, carLon, pickupLat, pickupLon, dropLat, dropLon;
let distToClient=0, distWithClient=0;
let currentRide=null;
let waitStart=null;
let poiMarkers=[];

map=L.map('map').setView([48.15,17.11],13);
L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(map);

window.onload = () => { checkAppPin(); } 
function checkAppPin(){
  const pin = prompt("Zadaj PIN pre vstup do aplikÃ¡cie:");
  if(pin!==APP_PIN){
    alert("NesprÃ¡vny PIN. AplikÃ¡cia sa zatvÃ¡ra.");
    document.body.innerHTML="<h2 style='text-align:center;color:red'>PrÃ­stup zamietnutÃ½</h2>";
  }
}

function getGPS(){
  navigator.geolocation.getCurrentPosition(pos=>{
    carLat=pos.coords.latitude;
    carLon=pos.coords.longitude;
    if(carMarker) map.removeLayer(carMarker);
    carMarker=L.marker([carLat,carLon]).addTo(map).bindPopup("Vozidlo").openPopup();
    map.setView([carLat,carLon],14);
  },()=>alert("GPS sa nepodarilo naÄÃ­taÅ¥"));
}

async function suggest(input,box){
  if(input.value.length<3){ box.innerHTML=""; return; }
  let url=`https://nominatim.openstreetmap.org/search?format=json&limit=5&q=${encodeURIComponent(input.value)}`;
  if(carLat) url+=`&lat=${carLat}&lon=${carLon}&bounded=1`;
  const r=await fetch(url);
  const d=await r.json();
  box.innerHTML="";
  d.forEach(p=>{
    const div=document.createElement("div");
    div.textContent=p.display_name;
    div.onclick=()=>{
      input.value=p.display_name;
      box.innerHTML="";
    };
    box.appendChild(div);
  });
}
pickup.oninput=()=>suggest(pickup,pickupSug);
dropoff.oninput=()=>suggest(dropoff,dropoffSug);

async function geocode(addr){
  const r=await fetch(`https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(addr)}`);
  const d=await r.json();
  if(!d[0]) throw "Adresa nenÃ¡jdenÃ¡";
  return {lat:+d[0].lat,lon:+d[0].lon};
}

function km(a,b,c,d){
  const R=6371;
  const dLat=(c-a)*Math.PI/180;
  const dLon=(d-b)*Math.PI/180;
  const x=Math.sin(dLat/2)**2+Math.cos(a*Math.PI/180)*Math.cos(c*Math.PI/180)*Math.sin(dLon/2)**2;
  return R*2*Math.atan2(Math.sqrt(x),Math.sqrt(1-x));
}

async function calculate(){
  try{
    if(!carLat) return alert("Najprv urÄ polohu vozidla");
    const p=await geocode(pickup.value);
    const d=await geocode(dropoff.value);
    pickupLat=p.lat; pickupLon=p.lon;
    dropLat=d.lat; dropLon=d.lon;
    if(pickupMarker) map.removeLayer(pickupMarker);
    if(dropMarker) map.removeLayer(dropMarker);
    pickupMarker=L.marker([pickupLat,pickupLon]).addTo(map).bindPopup("NÃ¡stup").openPopup();
    dropMarker=L.marker([dropLat,dropLon]).addTo(map).bindPopup("CieÄ¾").openPopup();
    map.fitBounds([[carLat,carLon],[dropLat,dropLon]]);
    distToClient=km(carLat,carLon,pickupLat,pickupLon)||0;
    distWithClient=km(pickupLat,pickupLon,dropLat,dropLon)||0;
    updateResults();
  }catch(e){ console.error(e); alert("Chyba vÃ½poÄtu. Skontroluj adresy alebo GPS polohu.");}
}

function calcWaitCost(){
  if(!waitStart) return 0;
  const minutes=(new Date()-waitStart)/60000;
  waitStart=null;
  return (minutes/60)*WAIT_RATE;
}

function updateResults(){
  const price=parseFloat(priceInput.value)||0;
  const luggage=parseInt(document.getElementById("luggage").value)||0;
  const luggageCost=luggage*2;
  const waitCost=calcWaitCost();
  const cost=(distToClient*RATE_TO_CLIENT + distWithClient*RATE_WITH_CLIENT + luggageCost + waitCost)||0;
  const recommended=cost*(1+RECOMMENDED_MARGIN);
  const diff=price-cost;
  results.innerHTML=`
    <p>ğŸš— Km po klienta: ${distToClient.toFixed(2)}</p>
    <p>ğŸ‘¤ Km s klientom: ${distWithClient.toFixed(2)}</p>
    <p>ğŸ’¼ PrÃ­platky: ${luggageCost.toFixed(2)} â‚¬</p>
    <p>â±ï¸ ÄŒakanie: ${waitCost.toFixed(2)} â‚¬</p>
    <p>ğŸ’° NÃ¡klady: ${cost.toFixed(2)} â‚¬</p>
    <p>ğŸ“Š DoporuÄenÃ¡ cena: ${recommended.toFixed(2)} â‚¬</p>
    <p class="${diff>=0?'green':'red'}">${diff>=0?'Zisk':'Strata'}: ${diff.toFixed(2)} â‚¬</p>
  `;
}

function startRide(){
  if(!carLat||!pickupLat||!dropLat) return alert("ChÃ½ba GPS alebo adresy");
  currentRide={startTime:new Date(),kmTo:distToClient,kmWith:distWithClient,cost:distToClient*RATE_TO_CLIENT + distWithClient*RATE_WITH_CLIENT,price:parseFloat(priceInput.value)||0};
  alert("Jazda zaÄala");
}

function endRide(){
  if(!currentRide) return alert("Jazda nebola zaÄatÃ¡");
  currentRide.endTime=new Date();
  currentRide.diff=currentRide.price-currentRide.cost;
  currentRide.duration=((currentRide.endTime-currentRide.startTime)/60000).toFixed(2);
  let rides=JSON.parse(localStorage.getItem("rides")||"[]");
  rides.push(currentRide);
  localStorage.setItem("rides",JSON.stringify(rides));
  currentRide=null;
  alert("Jazda ukonÄenÃ¡ a uloÅ¾enÃ¡");
}

function startWait(){
  if(waitStart){ alert("ÄŒakanie uÅ¾ beÅ¾Ã­"); return; }
  waitStart=new Date();
  alert("ÄŒakanie spustenÃ©");
}

function navToClient(){ if(!pickupLat) return alert("ChÃ½ba nÃ¡stup"); window.open(`https://www.google.com/maps/dir/?api=1&destination=${pickupLat},${pickupLon}`);}
function navClientRoute(){ if(!pickupLat||!dropLat) return alert("ChÃ½ba trasa"); window.open(`https://www.google.com/maps/dir/?api=1&origin=${pickupLat},${pickupLon}&destination=${dropLat},${dropLon}`);}

function showStats(){
  let rides=JSON.parse(localStorage.getItem("rides")||"[]");
  if(!rides.length){ alert("Å½iadne jazdy"); return; }
  let totalKmTo=0,totalKmWith=0,totalCost=0,totalPrice=0,totalDiff=0,totalTime=0;
  rides.forEach(r=>{
    totalKmTo+=Number(r.kmTo)||0;
    totalKmWith+=Number(r.kmWith)||0;
    totalCost+=Number(r.cost)||0;
    totalPrice+=Number(r.price)||0;
    totalDiff+=Number(r.diff)||0;
    totalTime+=Number(r.duration)||0;
  });
  let totalKm=totalKmTo+totalKmWith;
  let realValuePerKm=totalKmWith? (totalPrice/totalKmWith).toFixed(2):0;

  alert(`PoÄet jÃ¡zd: ${rides.length}
Km po klienta: ${totalKmTo.toFixed(2)}
Km s klientom: ${totalKmWith.toFixed(2)}
CelkovÃ© km: ${totalKm.toFixed(2)}
NÃ¡klady: ${totalCost.toFixed(2)} â‚¬
Cena z cennÃ­ka: ${totalPrice.toFixed(2)} â‚¬
CelkovÃ½ zisk/strata: ${totalDiff.toFixed(2)} â‚¬
CelkovÃ½ Äas jazdy: ${totalTime.toFixed(2)} min
ReÃ¡lna hodnota 1 km: ${realValuePerKm} â‚¬/km`);
}

function clearStats(){
  if(confirm("Naozaj zmazaÅ¥ vÅ¡etky uloÅ¾enÃ© jazdy?")){
    localStorage.removeItem("rides");
    alert("Å tatistika vymazanÃ¡");
    const ctx=document.getElementById("chart").getContext("2d");
    ctx.clearRect(0,0,ctx.canvas.width,ctx.canvas.height);
  }
}

function showPinModal(){ document.getElementById("pinModal").style.display="flex"; }
function checkPin(){
  const val=document.getElementById("pinInput").value;
  if(val===SADZBY_PIN){ alert("PIN sprÃ¡vny â€“ tu sa dajÃº meniÅ¥ sadzby"); document.getElementById("pinModal").style.display="none"; document.getElementById("pinInput").value=""; }
  else alert("PIN nesprÃ¡vny");
}

// --- POI ---
async function showPOI(){
  if(!pickupLat || !dropLat) return alert("Zadaj nÃ¡stup a cieÄ¾ klienta");
  const type = document.getElementById("poiType").value;
  const query = `
    [out:json];
    (
      node[amenity=${type}](${Math.min(pickupLat,dropLat)},${Math.min(pickupLon,dropLon)},${Math.max(pickupLat,dropLat)},${Math.max(pickupLon,dropLon)});
      way[amenity=${type}](${Math.min(pickupLat,dropLat)},${Math.min(pickupLon,dropLon)},${Math.max(pickupLat,dropLat)},${Math.max(pickupLon,dropLon)});
      relation[amenity=${type}](${Math.min(pickupLat,dropLat)},${Math.min(pickupLon,dropLon)},${Math.max(pickupLat,dropLat)},${Math.max(pickupLon,dropLon)});
    );
    out center 20;
  `;
  try{
    const res = await fetch('https://overpass-api.de/api/interpreter', {method:'POST', body:query});
    const data = await res.json();
    poiMarkers.forEach(m=>map.removeLayer(m));
    poiMarkers = [];
    data.elements.forEach(el=>{
      let lat=el.lat||el.center?.lat;
      let lon=el.lon||el.center?.lon;
      if(!lat||!lon) return;
      const m = L.marker([lat,lon],{icon:L.icon({iconUrl: type==='hotel'?'https://img.icons8.com/ios-filled/50/000000/hotel.png': type==='restaurant'?'https://img.icons8.com/ios-filled/50/000000/restaurant.png':'https://img.icons8.com/ios-filled/50/000000/fuel.png',iconSize:[32,32]})})
                  .addTo(map).bindPopup(`${type.toUpperCase()}<br><button onclick="addToRoute(${lat},${lon})">â¡ï¸ PridaÅ¥ do trasy</button>`);
      poiMarkers.push(m);
    });
    alert(`ZobrazenÃ½ch ${poiMarkers.length} POI bodov typu ${type}`);
  }catch(e){ console.error(e); alert("Chyba pri naÄÃ­tanÃ­ POI"); }
}

function addToRoute(lat,lon){
  if(!pickupLat || !dropLat) return alert("Zadaj trasu");
  const url=`https://www.google.com/maps/dir/?api=1&origin=${pickupLat},${pickupLon}&destination=${dropLat},${dropLon}&waypoints=${lat},${lon}`;
  window.open(url);
}
</script>
</body>
</html>
