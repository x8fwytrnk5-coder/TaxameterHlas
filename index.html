<!DOCTYPE html>
<html lang="sk">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>ZiskoMeter</title>

<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

<style>
body{
  font-family: -apple-system,BlinkMacSystemFont,Segoe UI,Roboto,Arial;
  margin: 0;
  padding: 15px;
  background:
    linear-gradient(rgba(255,255,255,0.65), rgba(255,255,255,0.65)),
    url('https://cdn.pixabay.com/photo/2017/01/14/12/59/taxi-1989244_1280.jpg') no-repeat center center fixed;
  background-size: cover;
}
.container{max-width:700px;margin:auto;background:rgba(255,255,255,0.85);padding:15px;border-radius:10px;}
h1{text-align:center;display:flex;align-items:center;justify-content:center;gap:10px;font-size:32px;font-weight:700;color:#333;text-shadow:1px 1px 4px rgba(0,0,0,0.3);}
h1 i{color:#FFD700;font-size:45px;filter: drop-shadow(2px 2px 3px rgba(0,0,0,0.5));}
label{font-weight:600;margin-top:10px;display:block;}
input,button{width:100%;padding:10px;margin-top:5px;font-size:16px;}
button{background:#007aff;color:#fff;border:none;border-radius:6px;}
#map{height:300px;margin-top:15px;border-radius:8px;}
.result{margin-top:15px;padding:12px;border-radius:6px;font-size:16px;}
footer{margin-top:25px;text-align:center;font-size:13px;color:#666;}
#lockScreen{position:fixed;inset:0;background:#f4f6f8;display:flex;align-items:center;justify-content:center;z-index:9999;}
#lockScreen div{background:white;padding:20px;border-radius:10px;max-width:300px;width:100%;}
#pinInput{width:100%;padding:10px;font-size:16px;margin-top:5px;}
#pinMsg{color:red;margin-top:10px;}
.suggestions{position:absolute; top:100%; left:0; right:0; background:white; border:1px solid #ccc; z-index:1000; max-height:150px; overflow-y:auto;}
.suggestions div{padding:5px;cursor:pointer;}
.suggestions div:hover{background:#eee;}
.autocomplete-wrapper{position:relative;}
</style>
</head>

<body>

<!-- PIN apky -->
<div id="lockScreen">
  <div>
    <h3>Zadaj PIN</h3>
    <input type="password" id="pinInput" placeholder="PIN">
    <button onclick="unlockApp()">Odomknúť</button>
    <div id="pinMsg"></div>
  </div>
</div>

<div class="container">
<h1><i class="fa-solid fa-car-side"></i> ZiskoMeter</h1>

<label>Poloha vozidla</label>
<input id="carPos" placeholder="Načítava sa GPS…" readonly>

<label>Miesto nástupu klienta</label>
<div class="autocomplete-wrapper">
  <input id="pickup" placeholder="Zadaj adresu" autocomplete="off">
  <div id="pickupSuggestions" class="suggestions"></div>
</div>

<label>Cieľ klienta</label>
<div class="autocomplete-wrapper">
  <input id="dropoff" placeholder="Zadaj cieľ" autocomplete="off">
  <div id="dropoffSuggestions" class="suggestions"></div>
</div>

<label>Cena z cenníka (€)</label>
<input id="price" type="number" placeholder="Zadá vodič">

<button onclick="calculate()">Vypočítať</button>

<div id="map"></div>
<div id="result" class="result">Výsledok sa zobrazí tu</div>

<!-- PIN pre nastavenie sadzieb -->
<div id="settingsLock" style="display:none; margin-top:10px; padding:10px; border:1px solid #aaa; border-radius:6px;">
  <label>Zadaj PIN pre úpravu sadzieb</label>
  <input type="password" id="settingsPin" placeholder="PIN sadzieb">
  <button onclick="unlockSettings()">Odomknúť nastavenia</button>
  <div id="settingsPinMsg" style="color:red;margin-top:5px;"></div>
</div>

<!-- Nastavenie sadzieb -->
<div id="settings" style="display:none; margin-top:15px; padding:10px; border:1px solid #ccc; border-radius:8px;">
  <h3>Nastavenie sadzieb</h3>
  
  <label>Sadzba za 1 km – trasa po klienta (€)</label>
  <input id="rateToClient" type="number" step="0.01">
  
  <label>Sadzba za 1 km – s klientom (€)</label>
  <input id="rateWithClient" type="number" step="0.01">
  
  <label>Sadzba za 1 hod. čakania (€)</label>
  <input id="rateWaiting" type="number" step="0.01">
  
  <label>Príplatky / služby (€)</label>
  <input id="extraServices" type="number" step="0.01" placeholder="napr. batožina, VIP...">
  
  <button onclick="saveRates()">Uložiť sadzby</button>
  
  <hr>
  <h4>Zmena PIN sadzieb</h4>
  <label>Nový PIN</label>
  <input type="password" id="newSettingsPin" placeholder="Zadaj nový PIN">
  <button onclick="changeSettingsPin()">Uložiť nový PIN</button>
</div>

<footer>
© 2025 – Autor: <strong>Peter Lukáč</strong><br>
Použitie len so súhlasom autora
</footer>
</div>

<script src="https://cdnjs.cloudflare.com/ajax/libs/crypto-js/4.1.1/crypto-js.min.js"></script>
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

<script>
/* --- PIN apky --- */
const APP_PIN_HASH = "202cb962ac59075b964b07152d234b70"; // MD5 "123"
function unlockApp(){
  const pin = document.getElementById("pinInput").value;
  if(CryptoJS.MD5(pin).toString()===APP_PIN_HASH){
    localStorage.setItem("authorizedApp","true");
    document.getElementById("lockScreen").style.display="none";
    document.getElementById("settingsLock").style.display="block";
  }else{
    document.getElementById("pinMsg").textContent="Nesprávny PIN";
  }
}
if(localStorage.getItem("authorizedApp")==="true"){
  document.getElementById("lockScreen").style.display="none";
  document.getElementById("settingsLock").style.display="block";
}

/* --- PIN nastavenia sadzieb --- */
const DEFAULT_SETTINGS_PIN_HASH = "e10adc3949ba59abbe56e057f20f883e"; // MD5 "123456"

function getSettingsPinHash(){
  return localStorage.getItem("SETTINGS_PIN_HASH") || DEFAULT_SETTINGS_PIN_HASH;
}

function unlockSettings(){
  const pin = document.getElementById("settingsPin").value;
  if(CryptoJS.MD5(pin).toString() === getSettingsPinHash()){
    document.getElementById("settings").style.display="block";
    document.getElementById("settingsLock").style.display="none";
    // Načítať uložené sadzby alebo default
    document.getElementById("rateToClient").value = localStorage.getItem("rateToClient") || 0.31;
    document.getElementById("rateWithClient").value = localStorage.getItem("rateWithClient") || 0.85;
    document.getElementById("rateWaiting").value = localStorage.getItem("rateWaiting") || 10;
    document.getElementById("extraServices").value = localStorage.getItem("extraServices") || 0;
  } else {
    document.getElementById("settingsPinMsg").textContent="Nesprávny PIN";
  }
}

function changeSettingsPin(){
  const newPin = document.getElementById("newSettingsPin").value;
  if(newPin.length<4){ alert("PIN musí mať aspoň 4 číslice"); return; }
  const hash = CryptoJS.MD5(newPin).toString();
  localStorage.setItem("SETTINGS_PIN_HASH", hash);
  alert("Nový PIN sadzieb bol uložený");
  document.getElementById("newSettingsPin").value="";
}

/* --- MAPA --- */
let map = L.map('map').setView([48.1486,17.1077],13);
L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png',{attribution:'© OpenStreetMap'}).addTo(map);
let markers=[];

/* --- GPS --- */
let carLocation = null;
async function reverseGeocode(lat, lon){
  const r = await fetch(`https://nominatim.openstreetmap.org/reverse?format=json&lat=${lat}&lon=${lon}`);
  const d = await r.json();
  return d.display_name || `${lat.toFixed(5)}, ${lon.toFixed(5)}`;
}
navigator.geolocation.getCurrentPosition(async pos=>{
  const lat = pos.coords.latitude;
  const lon = pos.coords.longitude;
  carLocation = { lat, lon };
  const address = await reverseGeocode(lat, lon);
  document.getElementById("carPos").value = address;
  map.setView([lat, lon], 14);
  markers.push(L.marker([lat, lon]).addTo(map).bindPopup("Vozidlo"));
});

/* --- GEOKÓDOVANIE ADRESY --- */
async function geocode(addr){
  const r=await fetch("https://nominatim.openstreetmap.org/search?format=json&q="+encodeURIComponent(addr));
  const d=await r.json();
  return d.length?{lat:+d[0].lat,lon:+d[0].lon}:null;
}

/* --- VZDIALENOSŤ --- */
async function distance(a,b){
  const r=await fetch(`https://router.project-osrm.org/route/v1/driving/${a.lon},${a.lat};${b.lon},${b.lat}?overview=false`);
  const d=await r.json();
  return d.routes[0].distance/1000;
}

/* --- AUTOCOMPLETE --- */
async function fetchSuggestions(query, loc){
  if(!query || !loc) return [];
  const r = await fetch(`https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(query)}&limit=5&viewbox=${loc.lon-0.05},${loc.lat+0.05},${loc.lon+0.05},${loc.lat-0.05}`);
  const d = await r.json();
  return d.map(item=>({display:item.display_name,lat:+item.lat,lon:+item.lon}));
}

function setupAutocomplete(inputId, suggestionId){
  const input = document.getElementById(inputId);
  const suggestionBox = document.getElementById(suggestionId);
  input.addEventListener("input", async ()=>{
    suggestionBox.innerHTML = "";
    if(!carLocation) return;
    const results = await fetchSuggestions(input.value, carLocation);
    results.forEach(r=>{
      const div = document.createElement("div");
      div.textContent = r.display;
      div.addEventListener("click", ()=>{
        input.value = r.display;
        input.dataset.lat = r.lat;
        input.dataset.lon = r.lon;
        suggestionBox.innerHTML="";
      });
      suggestionBox.appendChild(div);
    });
  });
}
setupAutocomplete("pickup","pickupSuggestions");
setupAutocomplete("dropoff","dropoffSuggestions");

/* --- SADZBY --- */
function getCurrentRates(){
  return {
    toClient: parseFloat(localStorage.getItem("rateToClient")) || 0.31,
    withClient: parseFloat(localStorage.getItem("rateWithClient")) || 0.85,
    waiting: parseFloat(localStorage.getItem("rateWaiting")) || 10,
    services: parseFloat(localStorage.getItem("extraServices")) || 0
  };
}

function saveRates(){
  const toClient = parseFloat(document.getElementById("rateToClient").value);
  const withClient = parseFloat(document.getElementById("rateWithClient").value);
  const waiting = parseFloat(document.getElementById("rateWaiting").value);
  const services = parseFloat(document.getElementById("extraServices").value);
  if(!isNaN(toClient)&&!isNaN(withClient)&&!isNaN(waiting)&&!isNaN(services)){
    localStorage.setItem("rateToClient", toClient);
    localStorage.setItem("rateWithClient", withClient);
    localStorage.setItem("rateWaiting", waiting);
    localStorage.setItem("extraServices", services);
    alert("Sadzieb boli uložené");
  } else { alert("Zadaj platné čísla"); }
}

/* --- VÝPOČET --- */
async function calculate(){
  const result=document.getElementById("result");
  result.textContent="Počítam…";
  try{
    markers.forEach(m=>map.removeLayer(m));
    markers=[];
    const pickupAddr=document.getElementById("pickup").value;
    const dropAddr=document.getElementById("dropoff").value;
    const price=parseFloat(document.getElementById("price").value);

    if(!pickupAddr||!dropAddr||isNaN(price)){
      result.textContent="Vyplň všetky údaje";
      return;
    }
    if(!carLocation){
      result.textContent="GPS poloha nie je dostupná";
      return;
    }

    const carLoc = carLocation;
    let pick = {lat:+document.getElementById("pickup").dataset.lat||0, lon:+document.getElementById("pickup").dataset.lon||0};
    let drop = {lat:+document.getElementById("dropoff").dataset.lat||0, lon:+document.getElementById("dropoff").dataset.lon||0};

    if(pick.lat===0 || drop.lat===0){
      pick = await geocode(pickupAddr);
      drop = await geocode(dropAddr);
      if(!pick||!drop){
        result.textContent="Adresu sa nepodarilo nájsť";
        return;
      }
    }

    markers.push(L.marker([carLoc.lat,carLoc.lon]).addTo(map).bindPopup("Vozidlo"));
    markers.push(L.marker([pick.lat,pick.lon]).addTo(map).bindPopup("Nástup"));
    markers.push(L.marker([drop.lat,drop.lon]).addTo(map).bindPopup("Cieľ"));

    const d1 = await distance(carLoc,pick);
    const d2 = await distance(pick,drop);

    const rates = getCurrentRates();
    const costs = d1*rates.toClient + d2*rates.withClient + rates.services;
    const diff = price-costs;

    result.innerHTML=
      `Cena jazdy: ${price.toFixed(2)} €<br>
       Náklady: ${costs.toFixed(2)} €<br>
       Výsledok: <strong style="color:${diff>=0?'green':'red'}">
       ${diff>=0?'Zisk':'Strata'} ${Math.abs(diff).toFixed(2)} €</strong>`;
  }catch(e){
    result.textContent="Chyba výpočtu";
    console.error(e);
  }
}
</script>
</body>
</html>
