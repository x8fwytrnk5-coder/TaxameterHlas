<!DOCTYPE html>
<html lang="sk">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Taxi â€“ kalkulaÄka & taxameter</title>

<style>
body {
  font-family:-apple-system,BlinkMacSystemFont,sans-serif;
  background:#f2f2f2;
  margin:0;
  padding:12px;
}
h1{text-align:center;}
.card{
  background:#fff;
  padding:14px;
  border-radius:12px;
  margin-bottom:12px;
}
label{
  font-weight:600;
  display:block;
  margin-top:10px;
}
.row{
  display:flex;
  gap:8px;
}
input{
  flex:1;
  padding:12px;
  font-size:16px;
}
button{
  padding:12px;
  font-size:16px;
  background:#007aff;
  color:#fff;
  border:none;
  border-radius:10px;
}
button.mic{
  background:#ff9500;
  width:54px;
}
button.secondary{background:#34c759;width:100%;}
.result{font-size:18px;font-weight:bold;}
.green{color:#0a7d00;}
.red{color:#c10000;}
iframe{
  width:100%;
  height:260px;
  border:none;
  border-radius:12px;
}
</style>
</head>

<body>

<h1>ğŸš• Taxi kalkulaÄka</h1>

<div class="card">
  <label>Poloha vozidla (GPS alebo ruÄne)</label>
  <input id="vehLat" placeholder="Latitude" type="number" step="any">
  <input id="vehLon" placeholder="Longitude" type="number" step="any">
  <button onclick="loadGPS()">ğŸ“ NaÄÃ­taÅ¥ GPS</button>

  <label>Miesto nÃ¡stupu klienta</label>
  <div class="row">
    <input id="startAddr" placeholder="Ulica, mesto">
    <button class="mic" onclick="dictate('startAddr')">ğŸ™ï¸</button>
  </div>

  <label>CieÄ¾ klienta</label>
  <div class="row">
    <input id="endAddr" placeholder="Ulica, mesto">
    <button class="mic" onclick="dictate('endAddr')">ğŸ™ï¸</button>
  </div>

  <label>Cena z cennÃ­ka (â‚¬)</label>
  <input id="priceInput">

  <label>BatoÅ¾ina (ks Ã— 2 â‚¬)</label>
  <input id="bags" type="number" min="0" value="0">

  <label>ÄalÅ¡ie prÃ­platky (â‚¬)</label>
  <input id="extras" type="number" min="0" value="0">

  <button class="secondary" onclick="calculate()">VypoÄÃ­taÅ¥</button>
</div>

<iframe id="map" src="https://www.openstreetmap.org/export/embed.html?layer=mapnik"></iframe>

<div class="card result" id="result">PripravenÃ©</div>

<script>
/* ===== KONÅ TANTY ===== */
const COST_RATE=0.31;
const BAG_RATE=2;
const GEO_CACHE_TTL=24*60*60*1000;

/* ===== CACHE ===== */
const geoCache={};

/* ===== GPS ===== */
function loadGPS(){
  navigator.geolocation.getCurrentPosition(
    pos=>{
      vehLat.value=pos.coords.latitude;
      vehLon.value=pos.coords.longitude;
      result.textContent="GPS naÄÃ­tanÃ©";
      updateMap(pos.coords.latitude,pos.coords.longitude);
    },
    ()=>result.textContent="GPS zlyhalo",
    {enableHighAccuracy:true,timeout:15000}
  );
}

/* ===== DIKTOVANIE ===== */
function dictate(targetId){
  if(!('webkitSpeechRecognition' in window)){
    alert("Diktovanie nie je podporovanÃ©");
    return;
  }
  const rec=new webkitSpeechRecognition();
  rec.lang="sk-SK";
  rec.interimResults=false;
  rec.maxAlternatives=1;

  rec.onresult=e=>{
    document.getElementById(targetId).value=e.results[0][0].transcript;
  };
  rec.onerror=()=>alert("Diktovanie zlyhalo");
  rec.start();
}

/* ===== GEOCODING ===== */
async function geocodeAddress(addr,retries=2){
  if(!addr||addr.length<3) throw "NeplatnÃ¡ adresa";
  const now=Date.now();
  if(geoCache[addr]&&(now-geoCache[addr].time)<GEO_CACHE_TTL)
    return geoCache[addr].coords;

  const c=new AbortController();
  const t=setTimeout(()=>c.abort(),10000);
  try{
    const r=await fetch(
      `https://nominatim.openstreetmap.org/search?format=json&limit=1&q=${encodeURIComponent(addr)}`,
      {signal:c.signal,headers:{'User-Agent':'TaxiApp/1.0'}}
    );
    const j=await r.json();
    if(!j.length) throw "Adresa nenÃ¡jdenÃ¡";
    const coords={lat:+j[0].lat,lon:+j[0].lon};
    geoCache[addr]={coords,time:now};
    return coords;
  }catch(e){
    if(retries>0){await new Promise(r=>setTimeout(r,800));return geocodeAddress(addr,retries-1);}
    throw e;
  }finally{clearTimeout(t);}
}

/* ===== TRASA ===== */
async function routeKm(aLat,aLon,bLat,bLon){
  const r=await fetch(`https://router.project-osrm.org/route/v1/driving/${aLon},${aLat};${bLon},${bLat}?overview=false`);
  const j=await r.json();
  if(!j.routes||!j.routes.length) throw "Trasa nenÃ¡jdenÃ¡";
  return j.routes[0].distance/1000;
}

/* ===== MAPA ===== */
function updateMap(lat,lon){
  map.src=`https://www.openstreetmap.org/export/embed.html?bbox=${lon-0.02},${lat-0.02},${lon+0.02},${lat+0.02}&layer=mapnik&marker=${lat},${lon}`;
}

/* ===== VÃPOÄŒET ===== */
async function calculate(){
  try{
    result.textContent="PoÄÃ­tamâ€¦";
    const vLat=parseFloat(vehLat.value);
    const vLon=parseFloat(vehLon.value);
    const price=parseFloat(priceInput.value);
    if(isNaN(vLat)||isNaN(vLon)||isNaN(price)) throw "ChÃ½bajÃº Ãºdaje";

    const bagsCount=parseInt(bags.value)||0;
    const extra=parseFloat(extras.value)||0;

    const start=await geocodeAddress(startAddr.value);
    const end=await geocodeAddress(endAddr.value);

    const km1=await routeKm(vLat,vLon,start.lat,start.lon);
    const km2=await routeKm(start.lat,start.lon,end.lat,end.lon);

    const costs=(km1+km2)*COST_RATE + bagsCount*BAG_RATE + extra;
    const diff=price-costs;

    result.innerHTML=`NÃ¡klady: ${costs.toFixed(2)} â‚¬<br>Cena: ${price.toFixed(2)} â‚¬<br>VÃ½sledok: ${diff.toFixed(2)} â‚¬`;
    result.className="card result "+(diff>=0?"green":"red");
  }catch(e){
    result.textContent="Chyba: "+e;
    result.className="card result red";
  }
}
</script>

</body>
</html>
